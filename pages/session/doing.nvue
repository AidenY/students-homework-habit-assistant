<template>
  <view class="page doing-page">
    <view class="top-card">
      <view class="time-row">
        <view class="time-block">
          <text class="time-label">å·²ç”¨æ—¶é—´</text>
          <text class="time-value">{{ elapsedText }}</text>
        </view>
        <view class="time-block">
          <text class="time-label">é¢„è®¡</text>
          <text class="time-value">{{ expectedText }}</text>
        </view>
      </view>
      <view class="progress-bar">
        <view class="progress-inner" :style="{ width: progressPercent + '%' }"></view>
      </view>
    </view>

    <view class="camera-card">
      <!-- ä½¿ç”¨ live-pusher ç»„ä»¶å®ç°æ‘„åƒå¤´é¢„è§ˆ -->
      <view class="camera-view-wrapper">
        <live-pusher
          id="livePusher"
          class="camera-view"
          url=""
          mode="SD"
          :autopush="false"
          :enable-camera="true"
          :device-position="devicePosition"
          :beauty="0"
          :whiteness="0"
          :aspect="aspect"
          :min-bitrate="200"
          :max-bitrate="1000"
          :waiting="false"
          :enable-mic="false"
          :muted="true"
          @statechange="onPusherStateChange"
          @netstatus="onPusherNetStatus"
          @error="onPusherError"
        ></live-pusher>
        <!-- å ä½ï¼šåªåœ¨æœªå¯åŠ¨æ—¶æ˜¾ç¤º -->
        <view v-if="!pusherReady" class="camera-placeholder">
          <text class="placeholder-text">æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ</text>
          <text class="placeholder-subtitle">{{ permissionGranted ? 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...' : 'æƒé™æˆäºˆåå°†æ˜¾ç¤ºå®æ—¶ç”»é¢' }}</text>
        </view>
      </view>
      <view class="camera-overlay">
        <text class="camera-title">å®æ—¶æ‘„åƒå¤´é¢„è§ˆ</text>
        <text class="camera-subtitle">
          å½“å‰ä½¿ç”¨ï¼š{{ devicePosition === 'front' ? 'å‰ç½®æ‘„åƒå¤´' : 'åç½®æ‘„åƒå¤´' }}
        </text>
        <view class="switch-row">
          <text class="camera-tip">ä¿æŒè„¸éƒ¨å‡ºç°åœ¨ç”»é¢ä¸­é—´ï¼Œæ›´å®¹æ˜“è¯†åˆ«å§¿æ€ï½</text>
          <view class="switch-btn" @click="switchCamera">
            <text class="switch-text">
              åˆ‡æ¢ä¸º{{ devicePosition === 'front' ? 'åç½®' : 'å‰ç½®' }}æ‘„åƒå¤´
            </text>
          </view>
        </view>
      </view>
      <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
      <view v-if="showDebugInfo" class="debug-panel">
        <text class="debug-title">è°ƒè¯•ä¿¡æ¯</text>
        <text class="debug-item">æƒé™çŠ¶æ€: {{ permissionStatus }}</text>
        <text class="debug-item">æ‘„åƒå¤´çŠ¶æ€: {{ cameraStatus }}</text>
        <text v-if="cameraError" class="debug-item debug-error">é”™è¯¯ä¿¡æ¯: {{ cameraError }}</text>
        <text v-if="cameraErrorDetail" class="debug-item debug-error">é”™è¯¯è¯¦æƒ…: {{ cameraErrorDetail }}</text>
        <view class="debug-btn-row">
          <view class="debug-btn" @click="toggleDebugInfo">
            <text class="debug-btn-text">éšè—è°ƒè¯•</text>
          </view>
          <view class="debug-btn" @click="checkCameraStatus">
            <text class="debug-btn-text">æ£€æŸ¥çŠ¶æ€</text>
          </view>
        </view>
      </view>
      <view v-else class="debug-toggle">
        <view class="debug-toggle-btn" @click="toggleDebugInfo">
          <text class="debug-toggle-text">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</text>
        </view>
      </view>
    </view>

    <view class="status-row">
      <view class="status-card" :class="'status-' + postureState">
        <text class="status-label">åå§¿</text>
        <text class="status-value">{{ postureLabel }}</text>
      </view>
      <view class="status-card" :class="'status-' + focusState">
        <text class="status-label">ä¸“æ³¨</text>
        <text class="status-value">{{ focusLabel }}</text>
      </view>
      <view class="status-card" :class="'status-' + taskState">
        <text class="status-label">çŠ¶æ€</text>
        <text class="status-value">{{ taskLabel }}</text>
      </view>
    </view>

    <view v-if="encourageText" class="encourage">
      <text class="encourage-text">{{ encourageText }}</text>
    </view>

    <view class="reminder-card">
      <view class="reminder-header">
        <text class="reminder-title">æœ€è¿‘æé†’</text>
        <text class="reminder-count">å…± {{ reminderCount }} æ¬¡</text>
      </view>
      <view v-if="lastReminderText" class="reminder-content" @click="replayLastReminder">
        <text class="reminder-icon">ğŸ””</text>
        <text class="reminder-text">{{ lastReminderText }}</text>
      </view>
      <view v-else class="reminder-empty">
        <text class="reminder-text">å½“å‰è¡¨ç°ä¸é”™ï¼Œç»§ç»­ä¿æŒï½</text>
      </view>
    </view>

    <view class="bottom-area">
      <view class="danger-btn" @click="endSession">
        <text class="danger-text">ç»“æŸä½œä¸š</text>
      </view>
    </view>
  </view>
</template>

<script>
import { startMockLoop, stopMockLoop } from '@/common/detectionService.js'
import { formatDuration } from '@/common/timeUtils.js'
import { playReminder } from '@/common/voiceReminder.js'
import { savePhoto } from '@/common/photoStorage.js'

export default {
  data() {
    return {
      startTime: 0,
      expectedDuration: 0,
      now: Date.now(),
      timer: null,
      snapshots: [],
      reminders: [],
      lastReminderText: '',
      reminderCount: 0,
      postureState: 'good',
      focusState: 'focus',
      taskState: 'writing',
      badStreak: 0,
      devicePosition: 'front',
      showDebugInfo: false,
      permissionStatus: 'æœªçŸ¥',
      cameraStatus: 'æœªçŸ¥',
      cameraError: '',
      cameraErrorDetail: '',
      pusherReady: false,
      pusherContext: null,
      permissionGranted: false,
      aspect: '9:16', // ç«–å±æ¯”ä¾‹
      photoTimer: null, // æ‹ç…§å®šæ—¶å™¨
      photos: [] // ä¿å­˜çš„ç…§ç‰‡åˆ—è¡¨
    }
  },
  computed: {
    elapsedText() {
      return formatDuration(this.now - this.startTime)
    },
    expectedText() {
      return formatDuration(this.expectedDuration)
    },
    progressPercent() {
      if (!this.expectedDuration) return 0
      const ratio = (this.now - this.startTime) / this.expectedDuration
      let p = Math.floor(ratio * 100)
      if (p < 0) p = 0
      if (p > 100) p = 100
      return p
    },
    postureLabel() {
      const map = {
        good: 'åå§¿ç«¯æ­£',
        bend: 'æœ‰ç‚¹è¶´æ¡Œ',
        lie: 'å‡ ä¹è¶´ä¸‹äº†',
        leave: 'ç¦»å¼€åº§ä½'
      }
      return map[this.postureState] || 'åå§¿ç«¯æ­£'
    },
    focusLabel() {
      const map = {
        focus: 'å¾ˆä¸“å¿ƒ',
        distract: 'æœ‰ç‚¹èµ°ç¥'
      }
      return map[this.focusState] || 'å¾ˆä¸“å¿ƒ'
    },
    taskLabel() {
      const map = {
        writing: 'æ­£åœ¨ä¹¦å†™',
        thinking: 'åœ¨æ€è€ƒ',
        idle: 'åœ¨å‘å‘†'
      }
      return map[this.taskState] || 'æ­£åœ¨ä¹¦å†™'
    },
    encourageText() {
      if (this.postureState === 'good' && this.focusState === 'focus') {
        return 'ç°åœ¨çš„çŠ¶æ€å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒå“¦ï¼'
      }
      return ''
    }
  },
  created() {
    // nvue ä¸­ä½¿ç”¨ created è·å–å‚æ•°
    const query = this.$route && this.$route.query ? this.$route.query : {}
    this.startTime = Number(query.startTime) || Date.now()
    this.expectedDuration = Number(query.expectedDuration) || 30 * 60 * 1000
    // ç”Ÿæˆä¼šè¯IDï¼ˆä½¿ç”¨ startTime ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
    this.sessionId = String(this.startTime)
    console.log('created: åˆå§‹åŒ– sessionId', this.sessionId, 'startTime', this.startTime)
  },
  mounted() {
    // nvue ä¸­ mounted ç”Ÿå‘½å‘¨æœŸ
    console.log('doing page mounted')
    // å»¶è¿Ÿåˆå§‹åŒ– live-pusherï¼Œç¡®ä¿ç»„ä»¶å·²å®Œå…¨æ¸²æŸ“
    setTimeout(() => {
      this.initLivePusher()
    }, 100)
  },
  onShow() {
    // ç¡®ä¿ startTime å’Œ sessionId éƒ½å·²è®¾ç½®
    if (!this.startTime || this.startTime === 0) {
      this.startTime = Date.now()
    }
    // ç¡®ä¿ sessionId å·²è®¾ç½®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
    if (!this.sessionId || this.sessionId === '' || this.sessionId === '0') {
      this.sessionId = String(this.startTime)
      console.log('onShow: åˆå§‹åŒ– sessionId', this.sessionId)
    }
    
    this.startTimers()
    this.startDetection()
    
    // ç¡®ä¿ live-pusher context å·²åˆ›å»º
    if (!this.pusherContext) {
      this.initLivePusher()
    }
    
    // è¯·æ±‚æƒé™
    this.requestCameraPermission()
  },
  onHide() {
    this.clearTimers()
    stopMockLoop()
    this.stopLivePusher()
  },
  beforeDestroy() {
    this.clearTimers()
    stopMockLoop()
    this.stopLivePusher()
  },
  methods: {
    startTimers() {
      this.now = Date.now()
      this.timer = setInterval(() => {
        this.now = Date.now()
      }, 1000)
    },
    clearTimers() {
      if (this.timer) {
        clearInterval(this.timer)
        this.timer = null
      }
      if (this.photoTimer) {
        clearInterval(this.photoTimer)
        this.photoTimer = null
      }
    },
    startDetection() {
      startMockLoop({
        intervalMs: 3000,
        onResult: snapshot => {
          this.snapshots.push(snapshot)
          this.postureState = snapshot.postureState
          this.focusState = snapshot.focusState
          this.taskState = snapshot.taskState

          const isBad =
            snapshot.postureState !== 'good' ||
            snapshot.focusState !== 'focus'
          if (isBad) {
            this.badStreak += 1
          } else {
            this.badStreak = 0
          }

          if (this.badStreak >= 2) {
            this.triggerReminder(snapshot)
            this.badStreak = 0
          }
        }
      })
      
      // å¯åŠ¨å®šæ—¶æ‹ç…§ï¼ˆæ¯30ç§’ï¼‰
      this.startPhotoCapture()
    },
    
    /**
     * å¯åŠ¨å®šæ—¶æ‹ç…§
     */
    startPhotoCapture() {
      // ç«‹å³æ‹ç¬¬ä¸€å¼ 
      this.capturePhoto()
      
      // æ¯30ç§’æ‹ä¸€å¼ 
      this.photoTimer = setInterval(() => {
        this.capturePhoto()
      }, 1000) // 1ç§’ = 1000æ¯«ç§’
    },
    
    /**
     * æ‹ç…§
     */
    capturePhoto() {
      if (!this.pusherContext || !this.pusherReady) {
        console.log('æ‘„åƒå¤´æœªå‡†å¤‡å¥½ï¼Œæ— æ³•æ‹ç…§')
        return
      }
      
      try {
        // ä½¿ç”¨ live-pusher çš„ snapshot æ–¹æ³•æ‹ç…§
        this.pusherContext.snapshot({
          quality: 'high', // é«˜è´¨é‡
          success: async (res) => {
            // æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
            // live-pusher çš„ snapshot è¿”å›æ ¼å¼å¯èƒ½æ˜¯ { message: { tempImagePath, height, width } }
            console.log('snapshot è¿”å›æ•°æ®', res)
            
            let photoPath = null
            if (res.message && res.message.tempImagePath) {
              // æ ‡å‡†æ ¼å¼ï¼š{ message: { tempImagePath: "..." } }
              photoPath = res.message.tempImagePath
            } else if (res.tempImagePath) {
              // ç›´æ¥æ ¼å¼ï¼š{ tempImagePath: "..." }
              photoPath = res.tempImagePath
            } else if (res.tempFilePath) {
              photoPath = res.tempFilePath
            } else if (res.path) {
              photoPath = res.path
            } else if (res.filePath) {
              photoPath = res.filePath
            }
            
            if (!photoPath) {
              console.error('æ‹ç…§å¤±è´¥ï¼šæœªè·å–åˆ°ç…§ç‰‡è·¯å¾„', res)
              uni.showToast({
                title: 'æ‹ç…§å¤±è´¥ï¼šæœªè·å–åˆ°ç…§ç‰‡è·¯å¾„',
                icon: 'none',
                duration: 2000
              })
              return
            }
            
            console.log('è·å–åˆ°ç…§ç‰‡è·¯å¾„', photoPath)
            
            const timestamp = Date.now()
            const elapsedTime = timestamp - this.startTime
            const elapsedText = this.formatElapsedTime(elapsedTime)
            
            // ä¿å­˜ç…§ç‰‡ä¿¡æ¯åˆ°å†…å­˜ï¼ˆç”¨äºä¼ é€’åˆ°æŠ¥å‘Šé¡µï¼‰
            const photoInfo = {
              path: photoPath,
              timestamp: timestamp,
              elapsedTime: elapsedTime,
              elapsedText: elapsedText
            }
            
            this.photos.push(photoInfo)
            console.log('æ‹ç…§æˆåŠŸ', photoInfo)
            
            // ä¿å­˜åˆ° SQLite æ•°æ®åº“
            try {
              // ç¡®ä¿ sessionId å­˜åœ¨
              if (!this.sessionId || this.sessionId === '' || this.sessionId === '0') {
                this.sessionId = String(this.startTime)
                console.warn('capturePhoto: sessionId ä¸ºç©ºï¼Œé‡æ–°åˆå§‹åŒ–', this.sessionId)
              }
              
              console.log('å‡†å¤‡ä¿å­˜ç…§ç‰‡ï¼ŒsessionId:', this.sessionId, 'photoPath:', photoPath.substring(0, 50))
              
              await savePhoto(
                this.sessionId,
                photoPath,
                timestamp,
                elapsedTime,
                elapsedText
              )
              console.log('ç…§ç‰‡å·²ä¿å­˜åˆ°æ•°æ®åº“')
            } catch (dbErr) {
              console.error('ä¿å­˜ç…§ç‰‡åˆ°æ•°æ®åº“å¤±è´¥', dbErr)
              console.error('å¤±è´¥æ—¶çš„ sessionId:', this.sessionId, 'ç±»å‹:', typeof this.sessionId)
              // å³ä½¿æ•°æ®åº“ä¿å­˜å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨å†…å­˜ä¸­çš„ç…§ç‰‡
            }
            
            // å¯é€‰ï¼šæ˜¾ç¤ºæ‹ç…§æç¤º
            uni.showToast({
              title: `å·²ä¿å­˜ç…§ç‰‡ (${this.photos.length}å¼ )`,
              icon: 'none',
              duration: 1000
            })
          },
          fail: (err) => {
            console.error('æ‹ç…§å¤±è´¥', err)
          }
        })
      } catch (e) {
        console.error('æ‹ç…§å¼‚å¸¸', e)
      }
    },
    
    /**
     * æ ¼å¼åŒ–å·²ç”¨æ—¶é—´æ–‡æœ¬
     */
    formatElapsedTime(ms) {
      const totalSeconds = Math.floor(ms / 1000)
      const minutes = Math.floor(totalSeconds / 60)
      const seconds = totalSeconds % 60
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
    },
    async triggerReminder(snapshot) {
      const type =
        snapshot.postureState !== 'good'
          ? 'posture'
          : 'focus'
      const text = await playReminder(type)
      this.lastReminderText = text
      this.reminderCount += 1
      this.reminders.push({
        timestamp: Date.now(),
        type,
        text
      })
    },
    async replayLastReminder() {
      if (!this.lastReminderText) return
      await playReminder('repeat', this.lastReminderText)
    },
    switchCamera() {
      // åˆ‡æ¢æ‘„åƒå¤´
      this.devicePosition = this.devicePosition === 'front' ? 'back' : 'front'
      this.cameraStatus = `æ­£åœ¨åˆ‡æ¢åˆ°${this.devicePosition === 'front' ? 'å‰ç½®' : 'åç½®'}æ‘„åƒå¤´...`
      
      // live-pusher ä¼šè‡ªåŠ¨å“åº” device-position çš„å˜åŒ–
      if (this.pusherContext) {
        // å¯ä»¥è°ƒç”¨ switchCamera æ–¹æ³•ï¼ˆå¦‚æœæ”¯æŒï¼‰
        try {
          this.pusherContext.switchCamera({
            success: () => {
              console.log('æ‘„åƒå¤´åˆ‡æ¢æˆåŠŸ')
            },
            fail: (err) => {
              console.log('æ‘„åƒå¤´åˆ‡æ¢å¤±è´¥', err)
            }
          })
        } catch (e) {
          console.log('switchCamera æ–¹æ³•å¯èƒ½ä¸æ”¯æŒï¼Œä½¿ç”¨ device-position å±æ€§åˆ‡æ¢')
        }
      }
    },
    endSession() {
      const endTime = Date.now()
      stopMockLoop()
      this.clearTimers()

      const payload = {
        startTime: this.startTime,
        endTime,
        expectedDuration: this.expectedDuration,
        snapshots: this.snapshots,
        reminders: this.reminders,
        photos: this.photos // ä¼ é€’ç…§ç‰‡åˆ—è¡¨
      }

      uni.navigateTo({
        url: `/pages/session/report?sessionId=${this.sessionId}`,
        success: res => {
          res.eventChannel && res.eventChannel.emit('sessionFinished', payload)
        }
      })
    },
    /**
     * åˆå§‹åŒ– live-pusher
     */
    initLivePusher() {
      // åˆ›å»º live-pusher ä¸Šä¸‹æ–‡
      // æ³¨æ„ï¼šåœ¨ nvue ä¸­ï¼Œéœ€è¦ç¡®ä¿ç»„ä»¶å·²æ¸²æŸ“åæ‰èƒ½åˆ›å»º context
      this.$nextTick(() => {
        try {
          this.pusherContext = uni.createLivePusherContext('livePusher', this)
          console.log('live-pusher context created', this.pusherContext)
        } catch (e) {
          console.error('åˆ›å»º live-pusher context å¤±è´¥', e)
          // å»¶è¿Ÿé‡è¯•
          setTimeout(() => {
            try {
              this.pusherContext = uni.createLivePusherContext('livePusher', this)
              console.log('live-pusher context é‡è¯•æˆåŠŸ', this.pusherContext)
            } catch (e2) {
              console.error('live-pusher context é‡è¯•ä¹Ÿå¤±è´¥', e2)
            }
          }, 500)
        }
      })
    },

    /**
     * å¯åŠ¨ live-pusher é¢„è§ˆ
     */
    startLivePusher() {
      if (!this.pusherContext) {
        this.initLivePusher()
      }
      
      if (!this.permissionGranted) {
        console.log('æƒé™æœªæˆäºˆï¼Œç­‰å¾…æƒé™æˆäºˆåå†å¯åŠ¨')
        return
      }

      if (!this.pusherContext) {
        console.log('pusherContext ä¸å­˜åœ¨ï¼Œé‡æ–°åˆå§‹åŒ–')
        this.initLivePusher()
        // ç­‰å¾… context åˆ›å»º
        setTimeout(() => {
          this._doStartLivePusher()
        }, 300)
        return
      }

      this._doStartLivePusher()
    },

    /**
     * å®é™…æ‰§è¡Œå¯åŠ¨ live-pusher çš„æ–¹æ³•
     */
    _doStartLivePusher() {
      if (!this.pusherContext) {
        console.error('pusherContext ä»ç„¶ä¸å­˜åœ¨')
        return
      }

      // å…ˆå°è¯•ä½¿ç”¨ startPreview æ–¹æ³•ï¼ˆæ¨èç”¨äºé¢„è§ˆï¼‰
      if (typeof this.pusherContext.startPreview === 'function') {
        this.pusherContext.startPreview({
          success: () => {
            this.pusherReady = true
            this.cameraStatus = 'æ‘„åƒå¤´é¢„è§ˆå·²å¯åŠ¨ âœ“'
            console.log('live-pusher é¢„è§ˆå¯åŠ¨æˆåŠŸ')
          },
          fail: (err) => {
            console.error('live-pusher startPreview å¤±è´¥', err)
            // é™çº§åˆ° start æ–¹æ³•
            this._tryStartMethod()
          }
        })
      } else {
        // å¦‚æœ startPreview ä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ start
        this._tryStartMethod()
      }
    },

    /**
     * å°è¯•ä½¿ç”¨ start æ–¹æ³•
     */
    _tryStartMethod() {
      if (!this.pusherContext) return

      this.pusherContext.start({
        success: () => {
          this.pusherReady = true
          this.cameraStatus = 'æ‘„åƒå¤´é¢„è§ˆå·²å¯åŠ¨ âœ“'
          console.log('live-pusher start æ–¹æ³•æˆåŠŸ')
        },
        fail: (err) => {
          this.cameraStatus = 'å¯åŠ¨å¤±è´¥: ' + JSON.stringify(err)
          this.cameraError = JSON.stringify(err)
          console.error('live-pusher start æ–¹æ³•å¤±è´¥', err)
          
          // å°è¯•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          const errorMsg = err.errMsg || err.message || JSON.stringify(err)
          console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', errorMsg)
          
          if (!this.showDebugInfo) {
            this.showDebugInfo = true
          }
          
          uni.showToast({
            title: 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯',
            icon: 'none',
            duration: 3000
          })
        }
      })
    },

    /**
     * åœæ­¢ live-pusher é¢„è§ˆ
     */
    stopLivePusher() {
      if (this.pusherContext) {
        // å…ˆå°è¯• stopPreview
        this.pusherContext.stopPreview({
          success: () => {
            this.pusherReady = false
            console.log('live-pusher é¢„è§ˆå·²åœæ­¢')
          },
          fail: () => {
            // å¦‚æœ stopPreview å¤±è´¥ï¼Œå°è¯• stop
            this.pusherContext.stop({
              success: () => {
                this.pusherReady = false
                console.log('live-pusher å·²åœæ­¢')
              },
              fail: (err) => {
                console.log('live-pusher åœæ­¢å¤±è´¥', err)
              }
            })
          }
        })
      }
    },

    /**
     * è¯·æ±‚æ‘„åƒå¤´æƒé™
     */
    requestCameraPermission() {
      // App ç¯å¢ƒï¼šä½¿ç”¨ plus.android.requestPermissions
      // #ifdef APP-PLUS
      try {
        this.permissionStatus = 'è¯·æ±‚ä¸­...'
        
        plus.android.requestPermissions(
          ['android.permission.CAMERA'],
          (resultObj) => {
            const granted = resultObj.granted && resultObj.granted.length > 0
            if (granted) {
              this.permissionStatus = 'å·²æˆäºˆ'
              this.permissionGranted = true
              console.log('æ‘„åƒå¤´æƒé™å·²æˆäºˆ', resultObj)
              
              // æƒé™æˆäºˆåï¼Œå¯åŠ¨ live-pusher
              setTimeout(() => {
                this.startLivePusher()
              }, 300)
            } else {
              this.permissionStatus = 'è¢«æ‹’ç»'
              this.permissionGranted = false
              console.log('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»', resultObj)
            }
          },
          err => {
            this.permissionStatus = 'è¯·æ±‚å¤±è´¥: ' + JSON.stringify(err)
            this.permissionGranted = false
            console.log('æ‘„åƒå¤´æƒé™è¯·æ±‚å¤±è´¥: ' + JSON.stringify(err))
            uni.showToast({
              title: 'æœªæˆäºˆæ‘„åƒå¤´æƒé™ï¼Œæ— æ³•é¢„è§ˆç”»é¢',
              icon: 'none',
              duration: 3000
            })
          }
        )
      } catch (e) {
        this.permissionStatus = 'å¼‚å¸¸: ' + e.toString()
        this.permissionGranted = false
        console.log('æ‘„åƒå¤´æƒé™è¯·æ±‚å¼‚å¸¸: ' + e)
      }
      // #endif
      
      // H5 ç¯å¢ƒï¼šlive-pusher ä¼šè‡ªåŠ¨è¯·æ±‚æƒé™
      // #ifdef H5
      this.permissionGranted = true
      this.permissionStatus = 'H5 ç¯å¢ƒï¼Œlive-pusher è‡ªåŠ¨è¯·æ±‚æƒé™'
      setTimeout(() => {
        this.startLivePusher()
      }, 500)
      // #endif
    },
    /**
     * live-pusher çŠ¶æ€å˜åŒ–äº‹ä»¶
     */
    onPusherStateChange(e) {
      console.log('live-pusher state change', e)
      const code = e.detail.code
      
      switch (code) {
        case 1001: // å·²ç»è¿æ¥æ¨æµæœåŠ¡å™¨
          this.cameraStatus = 'å·²è¿æ¥æ¨æµæœåŠ¡å™¨'
          break
        case 1002: // å·²ç»è¿æ¥æ¨æµæœåŠ¡å™¨ï¼Œå¼€å§‹æ¨æµ
          this.pusherReady = true
          this.cameraStatus = 'æ‘„åƒå¤´é¢„è§ˆå·²å¯åŠ¨ âœ“'
          break
        case 1003: // ç½‘ç»œæ¥æ”¶åˆ°é¦–ä¸ªè§†é¢‘æ•°æ®åŒ…
          this.pusherReady = true
          this.cameraStatus = 'æ‘„åƒå¤´ç”»é¢å·²æ˜¾ç¤º âœ“'
          break
        case 1004: // è§†é¢‘æ’­æ”¾å¼€å§‹
          this.pusherReady = true
          this.cameraStatus = 'æ‘„åƒå¤´ç”»é¢å·²æ˜¾ç¤º âœ“'
          break
        case 1005: // è§†é¢‘æ’­æ”¾è¿›åº¦
          // æ­£å¸¸æ’­æ”¾ä¸­
          break
        case 1006: // è§†é¢‘æ’­æ”¾ç»“æŸ
          this.cameraStatus = 'è§†é¢‘æ’­æ”¾ç»“æŸ'
          break
        case 1007: // è§†é¢‘æ’­æ”¾Loading
          this.cameraStatus = 'è§†é¢‘åŠ è½½ä¸­...'
          break
        case 1008: // è§£ç å™¨å¯åŠ¨
          this.cameraStatus = 'è§£ç å™¨å¯åŠ¨'
          break
        case -1301: // æ‰“å¼€æ‘„åƒå¤´å¤±è´¥
          this.cameraError = 'æ‰“å¼€æ‘„åƒå¤´å¤±è´¥'
          this.cameraStatus = 'æ‰“å¼€æ‘„åƒå¤´å¤±è´¥'
          if (!this.showDebugInfo) {
            this.showDebugInfo = true
          }
          break
        case -1302: // æ‰“å¼€éº¦å…‹é£å¤±è´¥
          this.cameraError = 'æ‰“å¼€éº¦å…‹é£å¤±è´¥'
          break
        case -1303: // è§†é¢‘ç¼–ç å¤±è´¥
          this.cameraError = 'è§†é¢‘ç¼–ç å¤±è´¥'
          break
        case -1304: // éŸ³é¢‘ç¼–ç å¤±è´¥
          this.cameraError = 'éŸ³é¢‘ç¼–ç å¤±è´¥'
          break
        case -1305: // ä¸æ”¯æŒçš„è§†é¢‘åˆ†è¾¨ç‡
          this.cameraError = 'ä¸æ”¯æŒçš„è§†é¢‘åˆ†è¾¨ç‡'
          break
        case -1306: // ä¸æ”¯æŒçš„éŸ³é¢‘é‡‡æ ·ç‡
          this.cameraError = 'ä¸æ”¯æŒçš„éŸ³é¢‘é‡‡æ ·ç‡'
          break
        case -1307: // ç½‘ç»œæ–­è¿ï¼Œä¸”ç»å¤šæ¬¡é‡è¿æŠ¢æ•‘æ— æ•ˆï¼Œæ›´å¤šé‡è¯•è¯·é‡å¯æ¨æµ
          this.cameraError = 'ç½‘ç»œæ–­è¿'
          this.cameraStatus = 'ç½‘ç»œæ–­è¿'
          break
        case -1308: // å¼€å§‹å½•å±å¤±è´¥
          this.cameraError = 'å¼€å§‹å½•å±å¤±è´¥'
          break
        case -1309: // å½•å±å¤±è´¥
          this.cameraError = 'å½•å±å¤±è´¥'
          break
        default:
          console.log('æœªçŸ¥çŠ¶æ€ç :', code)
      }
    },

    /**
     * live-pusher ç½‘ç»œçŠ¶æ€äº‹ä»¶
     */
    onPusherNetStatus(e) {
      // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†ç½‘ç»œçŠ¶æ€ï¼Œç”¨äºä¼˜åŒ–
      // console.log('live-pusher net status', e)
    },

    /**
     * live-pusher é”™è¯¯äº‹ä»¶
     */
    onPusherError(e) {
      console.error('live-pusher error', e)
      this.cameraError = 'live-pusher é”™è¯¯: ' + JSON.stringify(e.detail)
      this.cameraStatus = 'æ‘„åƒå¤´é”™è¯¯'
      
      if (!this.showDebugInfo) {
        this.showDebugInfo = true
      }
      
      uni.showToast({
        title: 'æ‘„åƒå¤´é”™è¯¯ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯',
        icon: 'none',
        duration: 3000
      })
    },
    toggleDebugInfo() {
      this.showDebugInfo = !this.showDebugInfo
    },
    
    /**
     * æ£€æŸ¥æ‘„åƒå¤´çŠ¶æ€
     */
    checkCameraStatus() {
      // #ifdef APP-PLUS
      try {
        const main = plus.android.runtimeMainActivity()
        const pm = plus.android.invoke(main, 'getPackageManager')
        const hasCamera = plus.android.invoke(pm, 'hasSystemFeature', 'android.hardware.camera')
        
        // æ£€æŸ¥æ‘„åƒå¤´æ•°é‡
        const Camera = plus.android.importClass('android.hardware.Camera')
        const cameraCount = Camera.getNumberOfCameras()
        
        // æ£€æŸ¥æƒé™çŠ¶æ€
        const PackageManager = plus.android.importClass('android.content.pm.PackageManager')
        const permission = 'android.permission.CAMERA'
        const result = plus.android.invoke(main, 'checkSelfPermission', permission)
        const granted = result === PackageManager.PERMISSION_GRANTED
        
        this.permissionStatus = `æƒé™æ£€æŸ¥: ${granted ? 'å·²æˆäºˆ' : 'æœªæˆäºˆ'}`
        
        // æ›´æ–°æ‘„åƒå¤´çŠ¶æ€
        if (this.pusherReady) {
          this.cameraStatus = `live-pusher å·²å¯åŠ¨ (è®¾å¤‡æ”¯æŒ: ${hasCamera ? 'æ˜¯' : 'å¦'}, æ•°é‡: ${cameraCount})`
        } else {
          this.cameraStatus = `ç­‰å¾… live-pusher å¯åŠ¨... (è®¾å¤‡æ”¯æŒ: ${hasCamera ? 'æ˜¯' : 'å¦'}, æ•°é‡: ${cameraCount}, æƒé™: ${granted ? 'å·²æˆäºˆ' : 'æœªæˆäºˆ'})`
        }
      } catch (e) {
        this.cameraStatus = 'æ£€æŸ¥å¤±è´¥: ' + e.toString()
        console.log('æ£€æŸ¥æ‘„åƒå¤´çŠ¶æ€å¤±è´¥', e)
      }
      // #endif
    }
  }
}
</script>

<style>
.page {
  flex: 1;
  background-color: #f3f7ff;
  padding-left: 16rpx;
  padding-right: 16rpx;
  padding-top: 16rpx;
  padding-bottom: 140rpx;
}

.top-card {
  background-color: #ffffff;
  border-radius: 24rpx;
  padding: 20rpx;
  margin-bottom: 16rpx;
}

.time-row {
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 12rpx;
}

.time-block {
  flex: 1;
}

.time-label {
  font-size: 24rpx;
  color: #555555;
}

.time-value {
  font-size: 34rpx;
  font-weight: 600;
  color: #2c405a;
  margin-top: 4rpx;
}

.progress-bar {
  height: 14rpx;
  border-radius: 7rpx;
  background-color: #f0f3fa;
  overflow: hidden;
}

.progress-inner {
  height: 14rpx;
  border-radius: 7rpx;
  background-color: #4ba3ff;
}

.camera-card {
  margin-top: 12rpx;
  margin-bottom: 16rpx;
  border-radius: 24rpx;
  background-color: #ffffff;
  overflow: hidden;
}

.camera-view-wrapper {
  width: 750rpx;
  height: 520rpx;
  position: relative;
  background-color: #000000;
  overflow: hidden;
}

.camera-view {
  width: 750rpx;
  height: 520rpx;
  background-color: #000000;
}

.camera-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  width: 750rpx;
  height: 520rpx;
  background-color: #1a1a1a;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 1;
}

.placeholder-text {
  font-size: 32rpx;
  color: #ffffff;
  margin-bottom: 12rpx;
}

.placeholder-subtitle {
  font-size: 24rpx;
  color: #999999;
}

.camera-overlay {
  padding: 16rpx 20rpx 18rpx;
}

.camera-title {
  font-size: 30rpx;
  font-weight: 600;
  color: #2c405a;
  margin-bottom: 6rpx;
}

.camera-subtitle {
  font-size: 24rpx;
  color: #555555;
}

.switch-row {
  margin-top: 10rpx;
}

.camera-tip {
  font-size: 22rpx;
  color: #888888;
  margin-bottom: 6rpx;
}

.switch-btn {
  padding-left: 22rpx;
  padding-right: 22rpx;
  padding-top: 8rpx;
  padding-bottom: 8rpx;
  border-radius: 32rpx;
  background-color: #e6f1ff;
}

.switch-text {
  font-size: 24rpx;
  color: #2f80ff;
}

.debug-panel {
  margin-top: 12rpx;
  padding: 12rpx;
  background-color: #fff3cd;
  border-radius: 8rpx;
  border-width: 1rpx;
  border-color: #ffc107;
}

.debug-title {
  font-size: 26rpx;
  font-weight: 600;
  color: #856404;
  margin-bottom: 8rpx;
}

.debug-item {
  font-size: 22rpx;
  color: #856404;
  margin-bottom: 4rpx;
  lines: 3;
}

.debug-error {
  color: #dc3545;
}

.debug-btn-row {
  flex-direction: row;
  margin-top: 8rpx;
  justify-content: space-between;
}

.debug-btn {
  flex: 1;
  margin-right: 8rpx;
  padding: 6rpx 12rpx;
  background-color: #ffc107;
  border-radius: 6rpx;
  align-items: center;
  justify-content: center;
}

.debug-btn:last-child {
  margin-right: 0;
}

.debug-btn-text {
  font-size: 22rpx;
  color: #856404;
}

.debug-toggle {
  margin-top: 8rpx;
  align-items: center;
}

.debug-toggle-btn {
  padding: 6rpx 16rpx;
  background-color: #e6f1ff;
  border-radius: 6rpx;
}

.debug-toggle-text {
  font-size: 22rpx;
  color: #2f80ff;
}

.status-row {
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 8rpx;
}

.status-card {
  flex: 1;
  margin-right: 8rpx;
  border-radius: 20rpx;
  padding: 14rpx 16rpx;
  background-color: #f5f7fb;
}

.status-card:last-child {
  margin-right: 0;
}

.status-label {
  font-size: 24rpx;
  color: #555555;
}

.status-value {
  font-size: 28rpx;
  font-weight: 600;
  margin-top: 4rpx;
}

.status-good .status-value {
  color: #2f9b59;
}

.status-focus .status-value {
  color: #2f9b59;
}

.status-bend .status-value,
.status-distract .status-value,
.status-idle .status-value {
  color: #f0ad4e;
}

.status-lie .status-value,
.status-leave .status-value {
  color: #dd524d;
}

.encourage {
  margin-top: 4rpx;
  margin-bottom: 8rpx;
}

.encourage-text {
  font-size: 26rpx;
  color: #2f9b59;
}

.reminder-card {
  border-radius: 24rpx;
  background-color: #ffffff;
  padding: 18rpx 20rpx 20rpx;
  margin-bottom: 8rpx;
}

.reminder-header {
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 8rpx;
}

.reminder-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #2c405a;
}

.reminder-count {
  font-size: 24rpx;
  color: #555555;
}

.reminder-content {
  flex-direction: row;
  align-items: center;
}

.reminder-icon {
  font-size: 30rpx;
  margin-right: 6rpx;
}

.reminder-text {
  font-size: 26rpx;
  color: #3f536e;
}

.reminder-empty {
  font-size: 26rpx;
  color: #3f536e;
}

.bottom-area {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 40rpx;
  padding-left: 32rpx;
  padding-right: 32rpx;
}

.danger-btn {
  height: 88rpx;
  border-radius: 44rpx;
  background-color: #ff6b6b;
  align-items: center;
  justify-content: center;
}

.danger-text {
  font-size: 32rpx;
  color: #ffffff;
}
</style>


